<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPHyper - Network Analyzer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mapbox GL JS CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Inter Font (Vercel Style) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #000000;
            /* Pure Black */
            --bg-card: #111111;
            /* Almost Black */
            --bg-hover: #333333;
            /* Dark Grey */
            --border-color: #333333;
            /* Subtle Border */
            --primary: #ffffff;
            /* White for high contrast */
            --accent: #3291ff;
            /* Vercel Blue for accents */
            --text-main: #ffffff;
            /* White */
            --text-muted: #888888;
            /* Grey */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            background-color: #000000;
        }

        /* Custom Dark Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .loader {
            border: 2px solid #333;
            border-radius: 50%;
            border-top: 2px solid var(--text-main);
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Minimal Marker Pulse */
        .custom-marker-container {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marker-pulse {
            position: relative;
            width: 12px;
            height: 12px;
            background: var(--text-main);
            border-radius: 50%;
            box-shadow: 0 0 0 1px #000;
            pointer-events: none;
        }

        .marker-pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--text-main);
            animation: pulse-ring 2.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0.8;
            }

            100% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0;
            }
        }

        /* Vercel Style Popup */
        .mapboxgl-popup-content {
            background-color: var(--bg-dark) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-main) !important;
            border-radius: 6px !important;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8) !important;
            padding: 0 !important;
            min-width: 280px;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            /* Fixes corner bugs */
        }

        /* Remove Tip for Cleaner "Floating" Look */
        .mapboxgl-popup-tip {
            display: none !important;
        }

        /* Hide Mapbox Logo and Attribution */
        .mapboxgl-ctrl-logo,
        .mapboxgl-ctrl-attrib {
            display: none !important;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .mobile-sidebar-hidden {
                transform: translateX(-100%);
            }

            .mobile-sidebar-visible {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden font-sans antialiased selection:bg-indigo-500 selection:text-white">

    <!-- Header -->
    <header
        class="bg-black border-b border-[#333] shadow-sm z-30 px-4 py-3 md:px-6 md:py-4 flex justify-between items-center shrink-0 backdrop-blur-md bg-opacity-80">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="md:hidden text-[#888] hover:text-white p-1 transition-colors">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <div class="w-8 h-8 rounded-md bg-white text-black flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-bolt"></i>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-white hidden md:block" data-i18n="appTitle">IPHyper <span
                    class="text-[10px] font-medium text-[#666] ml-1 px-2 py-0.5 rounded-full border border-[#333] uppercase tracking-wider">Lite</span>
            </h1>
        </div>

        <div class="flex items-center gap-3">
            <select id="lang-selector" onchange="changeLanguage(this.value)"
                class="bg-black text-[#888] text-xs border border-[#333] rounded px-2 py-1 outline-none focus:border-white focus:text-white transition-colors cursor-pointer hover:border-[#555]">
                <option value="en">English</option>
                <option value="tr">Türkçe</option>
                <option value="es">Español</option>
                <option value="zh">中文</option>
                <option value="hi">हिन्दी</option>
                <option value="ar">العربية</option>
                <option value="pt">Português</option>
                <option value="bn">বাংলা</option>
                <option value="ru">Русский</option>
                <option value="ja">日本語</option>
                <option value="de">Deutsch</option>
                <option value="fr">Français</option>
                <option value="id">Bahasa Indonesia</option>
            </select>

            <button onclick="openInputModal()"
                class="md:hidden text-xs bg-white text-black hover:bg-[#ddd] px-3 py-1.5 rounded-md shadow-sm font-medium transition-colors"
                data-i18n="addBtn">
                <i class="fa-solid fa-plus"></i> Add
            </button>
            <div class="text-xs font-mono text-[#666] bg-[#111] px-3 py-1.5 rounded border border-[#333]">
                <span id="status-count" class="text-white font-bold">0</span> / <span id="total-count">0</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 h-full overflow-hidden relative">

        <!-- Sidebar -->
        <aside id="sidebar"
            class="absolute md:relative inset-y-0 left-0 w-3/4 md:w-80 bg-black border-r border-[#333] flex flex-col z-20 shadow-2xl md:shadow-none transition-transform duration-300 mobile-sidebar-hidden md:transform-none">
            <div class="p-4 border-b border-[#333] bg-black flex justify-between items-center">
                <div>
                    <h2 class="font-semibold text-white text-sm" data-i18n="targetList">Target List</h2>
                    <p class="text-[10px] uppercase tracking-wider text-[#666] font-bold mt-1" data-i18n="processQueue">
                        Process Queue</p>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-[#666] hover:text-white p-2 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
                <button onclick="openInputModal()"
                    class="hidden md:block text-[#666] hover:text-white transition-colors p-2 rounded hover:bg-[#111]">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
            </div>

            <div id="ip-list-container" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2">
                <div class="flex flex-col items-center justify-center h-40 text-[#444]">
                    <i class="fa-solid fa-layer-group text-3xl mb-3 opacity-20"></i>
                    <p class="text-xs" data-i18n="waitingData">Waiting for data...</p>
                </div>
            </div>

            <div class="p-4 border-t border-[#333] bg-black flex gap-2">
                <button onclick="openInputModal()"
                    class="flex-1 bg-black hover:bg-[#111] text-white font-medium py-2 px-2 rounded-md text-xs border border-[#333] hover:border-white transition-all duration-200">
                    <i class="fa-solid fa-pen mr-1"></i> <span data-i18n="editBtn">Edit</span>
                </button>
                <button onclick="startProcessing()" id="refresh-btn"
                    class="flex-1 bg-white hover:bg-[#f0f0f0] text-black font-medium py-2 px-2 rounded-md text-xs border border-white hover:border-[#ddd] disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <i class="fa-solid fa-rotate-right mr-1"></i> <span data-i18n="retryBtn">Retry</span>
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="toggleSidebar()"
            class="absolute inset-0 bg-black/50 z-10 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- Map -->
        <main class="flex-1 relative bg-black w-full h-full">
            <div id="map"></div>

            <div
                class="absolute bottom-2 right-2 bg-black/80 backdrop-blur-md border border-[#333] p-4 rounded-lg shadow-2xl z-[500] max-w-xs hidden md:block">
                <h3 class="font-bold text-white mb-2 text-xs uppercase tracking-wide flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved text-white"></i> <span data-i18n="systemStatus">System
                        Status</span>
                </h3>
                <p class="text-[11px] text-[#888] leading-relaxed" data-i18n="statusDesc">
                    Hover over markers to view detailed data provided by ipwho.is.
                </p>
            </div>
        </main>
    </div>

    <!-- Input Modal -->
    <div id="input-modal"
        class="fixed inset-0 z-[3000] bg-black/90 flex items-center justify-center backdrop-blur-md transition-opacity duration-300 p-4 hidden">
        <div
            class="bg-black border border-[#333] rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 p-6">
            <div class="text-center mb-6">
                <div
                    class="bg-[#111] w-12 h-12 rounded-md flex items-center justify-center mx-auto mb-4 border border-[#333]">
                    <i class="fa-solid fa-terminal text-white text-xl"></i>
                </div>
                <h2 class="text-xl font-bold text-white" data-i18n="defineTarget">Define Targets</h2>
                <p class="text-[#666] text-xs mt-2" data-i18n="enterIps">Enter IPv4 addresses to analyze.</p>
            </div>

            <textarea id="ip-input-textarea"
                class="w-full h-40 p-4 bg-[#050505] border border-[#333] rounded-md focus:outline-none focus:border-white focus:ring-1 focus:ring-white text-xs font-mono text-[#ddd] mb-5 resize-none placeholder-[#444] transition-colors"
                placeholder="8.8.8.8&#10;1.1.1.1, 192.168.1.1"></textarea>

            <div class="flex flex-col gap-3">
                <button onclick="processInputAndStart()"
                    class="w-full bg-white hover:bg-[#ddd] text-black font-bold py-3 px-4 rounded-md shadow-lg flex items-center justify-center gap-2 text-sm transition-all active:scale-95">
                    <i class="fa-solid fa-play"></i> <span data-i18n="startAnalysis">Start Analysis</span>
                </button>
                <button onclick="fillDemoData()"
                    class="text-xs text-[#666] hover:text-white transition cursor-pointer py-1" data-i18n="loadDemo">
                    Load demo data
                </button>
                <button onclick="closeInputModal()" class="text-xs text-[#444] hover:text-[#888] mt-2"
                    data-i18n="cancelBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal"
        class="fixed inset-0 z-[4000] bg-slate-950/90 flex items-center justify-center backdrop-blur-md transition-opacity duration-300 p-4 hidden">
        <div
            class="bg-slate-800 border border-rose-900/50 rounded-xl shadow-2xl w-full max-w-md overflow-hidden p-6 relative">
            <button onclick="closeErrorModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="text-center">
                <div
                    class="bg-rose-900/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-rose-500/30">
                    <i class="fa-solid fa-triangle-exclamation text-rose-500 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-2" data-i18n="errorTitle">Analysis Failed</h3>
                <p class="text-slate-300 text-sm mb-4" id="error-message">Connection error.</p>
                <button onclick="closeErrorModal()"
                    class="bg-rose-600 hover:bg-rose-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <script>
        // --- CONFIGURATION ---
        let currentLang = 'en';
        const CACHE_KEY = 'iphyper_cache';
        const MAX_CACHE_SIZE = 50;

        // --- I18N DATA ---
        const translations = {
            en: {
                appTitle: "IPHyper",
                targetList: "Target List",
                processQueue: "Process Queue",
                waitingData: "Waiting for data...",
                editBtn: "Edit",
                retryBtn: "Retry",
                systemStatus: "System Status",
                statusDesc: "Hover over markers to view details. Data provided by ipwho.is.",
                defineTarget: "Define Targets",
                enterIps: "Enter IPv4 addresses to analyze.",
                startAnalysis: "Start Analysis",
                loadDemo: "Load demo data",
                cancelBtn: "Cancel",
                addBtn: "Add",
                notFound: "Not Found",
                waiting: "Waiting...",
                emptyList: "List is empty",
                invalidIP: "No valid IP addresses found.",
                errorTitle: "Analysis Error",
                quotaError: "The daily quota for the API service has been exceeded. Please try again later.",

                // Detail Labels
                lbl_region: "Region",
                lbl_postal: "Postal",
                lbl_timezone: "Timezone",
                lbl_asn: "ASN",
                lbl_org: "Org",
                lbl_coords: "Coords"
            },
            tr: {
                appTitle: "IPHyper",
                targetList: "Hedef Listesi",
                processQueue: "İşlem Kuyruğu",
                waitingData: "Veri bekleniyor...",
                editBtn: "Düzenle",
                retryBtn: "Tekrarla",
                systemStatus: "Sistem Durumu",
                statusDesc: "Detaylar için marker üzerine gelin. Veriler ipwho.is üzerinden sağlanır.",
                defineTarget: "Hedef Tanımla",
                enterIps: "Analiz edilecek IPv4 adreslerini girin.",
                startAnalysis: "Analizi Başlat",
                loadDemo: "Örnek veri yükle",
                cancelBtn: "İptal",
                addBtn: "Ekle",
                notFound: "Bulunamadı",
                waiting: "Bekleniyor...",
                emptyList: "Liste boş",
                invalidIP: "Geçerli IP adresi bulunamadı.",
                errorTitle: "Analiz Hatası",
                quotaError: "API servisi için günlük kota doldu. Lütfen daha sonra tekrar deneyin.",

                lbl_region: "Bölge",
                lbl_postal: "Posta Kodu",
                lbl_timezone: "Saat Dilimi",
                lbl_asn: "ASN",
                lbl_org: "Kurum",
                lbl_coords: "Konum"
            },
            es: {
                appTitle: "IPHyper",
                targetList: "Lista de objetivos",
                processQueue: "Cola de proceso",
                waitingData: "Esperando datos...",
                editBtn: "Editar",
                retryBtn: "Reintentar",
                systemStatus: "Estado del sistema",
                statusDesc: "Pase el mouse sobre los marcadores para ver detalles.",
                defineTarget: "Definir objetivos",
                enterIps: "Ingrese direcciones IPv4 para analizar.",
                startAnalysis: "Iniciar análisis",
                loadDemo: "Cargar demo",
                cancelBtn: "Cancelar",
                addBtn: "Agregar",
                notFound: "No encontrado",
                waiting: "Esperando...",
                emptyList: "Lista vacía",
                invalidIP: "No se encontraron direcciones IP válidas.",
                errorTitle: "Error",
                quotaError: "Cuota diaria excedida.",
                lbl_region: "Región",
                lbl_postal: "Postal",
                lbl_timezone: "Zona Horaria",
                lbl_asn: "ASN",
                lbl_org: "Org",
                lbl_coords: "Coords"
            },
            zh: {
                appTitle: "IPHyper",
                targetList: "目标列表",
                processQueue: "处理队列",
                waitingData: "等待数据...",
                editBtn: "编辑",
                retryBtn: "重试",
                systemStatus: "系统状态",
                statusDesc: "将鼠标悬停在标记上以查看详细信息。",
                defineTarget: "定义目标",
                enterIps: "输入要分析的 IPv4 地址。",
                startAnalysis: "开始分析",
                loadDemo: "加载演示数据",
                cancelBtn: "取消",
                addBtn: "添加",
                notFound: "未找到",
                waiting: "等待中...",
                emptyList: "列表为空",
                invalidIP: "未找到有效的 IP 地址。",
                errorTitle: "错误",
                quotaError: "超出每日配额。",
                lbl_region: "地区",
                lbl_postal: "邮政",
                lbl_timezone: "时区",
                lbl_asn: "ASN",
                lbl_org: "组织",
                lbl_coords: "坐标"
            },
            hi: {
                appTitle: "IPHyper",
                targetList: "लक्ष्य सूची",
                processQueue: "प्रक्रिया कतार",
                waitingData: "डेटा की प्रतीक्षा है...",
                editBtn: "संपादित करें",
                retryBtn: "पुनः प्रयास करें",
                systemStatus: "सिस्टम स्थिति",
                statusDesc: "विवरण देखने के लिए मार्कर पर होवर करें।",
                defineTarget: "लक्ष्य परिभाषित करें",
                enterIps: "विश्लेषण के लिए IPv4 पते दर्ज करें।",
                startAnalysis: "विश्लेषण शुरू करें",
                loadDemo: "डेमो डेटा लोड करें",
                cancelBtn: "रद्द करें",
                addBtn: "जोड़ें",
                notFound: "नहीं मिला",
                waiting: "प्रतीक्षा कर रहा है...",
                emptyList: "सूची खाली है",
                invalidIP: "कोई मान्य IP पता नहीं मिला।",
                errorTitle: "त्रुटि",
                quotaError: "दैनिक कोटा पार हो गया।",
                lbl_region: "क्षेत्र",
                lbl_postal: "डाक",
                lbl_timezone: "समय क्षेत्र",
                lbl_asn: "ASN",
                lbl_org: "संगठन",
                lbl_coords: "निर्देशांक"
            },
            ar: {
                appTitle: "IPHyper",
                targetList: "قائمة الأهداف",
                processQueue: "قائمة الانتظار",
                waitingData: "انتظار البيانات...",
                editBtn: "تعديل",
                retryBtn: "إعادة المحاولة",
                systemStatus: "حالة النظام",
                statusDesc: "مرر الماوس فوق العلامات لعرض التفاصيل.",
                defineTarget: "تحديد الأهداف",
                enterIps: "أدخل عناوين IPv4 للتحليل.",
                startAnalysis: "بدء التحليل",
                loadDemo: "تحميل بيانات تجريبية",
                cancelBtn: "إلغاء",
                addBtn: "إضافة",
                notFound: "غير موجود",
                waiting: "انتظار...",
                emptyList: "القائمة فارغة",
                invalidIP: "لم يتم العثور على عناوين IP صالحة.",
                errorTitle: "خطأ",
                quotaError: "تجاوزت الحصة اليومية.",
                lbl_region: "منطقة",
                lbl_postal: "بريدي",
                lbl_timezone: "المنطقة الزمنية",
                lbl_asn: "ASN",
                lbl_org: "منظمة",
                lbl_coords: "إحداثيات"
            },
            pt: {
                appTitle: "IPHyper",
                targetList: "Lista de Alvos",
                processQueue: "Fila de Processamento",
                waitingData: "Aguardando dados...",
                editBtn: "Editar",
                retryBtn: "Tentar novamente",
                systemStatus: "Status do Sistema",
                statusDesc: "Passe o mouse sobre os marcadores para ver detalhes.",
                defineTarget: "Definir Alvos",
                enterIps: "Insira endereços IPv4 para analisar.",
                startAnalysis: "Iniciar Análise",
                loadDemo: "Carregar dados de demonstração",
                cancelBtn: "Cancelar",
                addBtn: "Adicionar",
                notFound: "Não encontrado",
                waiting: "Aguardando...",
                emptyList: "Lista vazia",
                invalidIP: "Nenhum endereço IP válido encontrado.",
                errorTitle: "Erro",
                quotaError: "Cota diária excedida.",
                lbl_region: "Região",
                lbl_postal: "Postal",
                lbl_timezone: "Fuso Horário",
                lbl_asn: "ASN",
                lbl_org: "Org",
                lbl_coords: "Coords"
            },
            bn: {
                appTitle: "IPHyper",
                targetList: "টার্গেট তালিকা",
                processQueue: "প্রসেস কিউ",
                waitingData: "ডেটার জন্য অপেক্ষা করা হচ্ছে...",
                editBtn: "সম্পাদনা",
                retryBtn: "পুনরায় চেষ্টা করুন",
                systemStatus: "সিস্টেম স্ট্যাটাস",
                statusDesc: "বিস্তারিত দেখতে মার্কারের উপর মাউস রাখুন।",
                defineTarget: "টার্গেট নির্ধারণ করুন",
                enterIps: "বিশ্লেষণের জন্য IPv4 ঠিকানা লিখুন।",
                startAnalysis: "বিশ্লেষণ শুরু করুন",
                loadDemo: "ডেমো ডেটা লোড করুন",
                cancelBtn: "বাতিল",
                addBtn: "যোগ করুন",
                notFound: "পাওয়া যায়নি",
                waiting: "অপেক্ষা করা হচ্ছে...",
                emptyList: "তালিকা খালি",
                invalidIP: "কোনো বৈধ IP ঠিকানা পাওয়া যায়নি।",
                errorTitle: "ত্রুটি",
                quotaError: "দৈনিক কোটা অতিক্রম করেছে।",
                lbl_region: "অঞ্চল",
                lbl_postal: "ডাক",
                lbl_timezone: "সময় অঞ্চল",
                lbl_asn: "ASN",
                lbl_org: "সংস্থা",
                lbl_coords: "স্থানাঙ্ক"
            },
            ru: {
                appTitle: "IPHyper",
                targetList: "Список целей",
                processQueue: "Очередь обработки",
                waitingData: "Ожидание данных...",
                editBtn: "Редактировать",
                retryBtn: "Повторить",
                systemStatus: "Статус системы",
                statusDesc: "Наведите курсор на маркеры для просмотра деталей.",
                defineTarget: "Определить цели",
                enterIps: "Введите IPv4 адреса для анализа.",
                startAnalysis: "Начать анализ",
                loadDemo: "Загрузить демо",
                cancelBtn: "Отмена",
                addBtn: "Добавить",
                notFound: "Не найдено",
                waiting: "Ожидание...",
                emptyList: "Список пуст",
                invalidIP: "Действительные IP-адреса не найдены.",
                errorTitle: "Ошибка",
                quotaError: "Дневная квота превышена.",
                lbl_region: "Регион",
                lbl_postal: "Почтовый",
                lbl_timezone: "Часовой пояс",
                lbl_asn: "ASN",
                lbl_org: "Орг",
                lbl_coords: "Координаты"
            },
            ja: {
                appTitle: "IPHyper",
                targetList: "ターゲットリスト",
                processQueue: "処理キュー",
                waitingData: "データを待機中...",
                editBtn: "編集",
                retryBtn: "再試行",
                systemStatus: "システムステータス",
                statusDesc: "マーカーにカーソルを合わせると詳細が表示されます。",
                defineTarget: "ターゲットを定義",
                enterIps: "分析するIPv4アドレスを入力してください。",
                startAnalysis: "分析を開始",
                loadDemo: "デモデータをロード",
                cancelBtn: "キャンセル",
                addBtn: "追加",
                notFound: "見つかりません",
                waiting: "待機中...",
                emptyList: "リストは空です",
                invalidIP: "有効なIPアドレスが見つかりませんでした。",
                errorTitle: "エラー",
                quotaError: "1日の割り当てを超えました。",
                lbl_region: "地域",
                lbl_postal: "郵便",
                lbl_timezone: "タイムゾーン",
                lbl_asn: "ASN",
                lbl_org: "組織",
                lbl_coords: "座標"
            },
            de: {
                appTitle: "IPHyper",
                targetList: "Zielliste",
                processQueue: "Verarbeitungswarteschlange",
                waitingData: "Warte auf Daten...",
                editBtn: "Bearbeiten",
                retryBtn: "Wiederholen",
                systemStatus: "Systemstatus",
                statusDesc: "Fahren Sie mit der Maus über Markierungen für Details.",
                defineTarget: "Ziele definieren",
                enterIps: "Geben Sie IPv4-Adressen zur Analyse ein.",
                startAnalysis: "Analyse starten",
                loadDemo: "Demodaten laden",
                cancelBtn: "Abbrechen",
                addBtn: "Hinzufügen",
                notFound: "Nicht gefunden",
                waiting: "Warten...",
                emptyList: "Liste ist leer",
                invalidIP: "Keine gültigen IP-Adressen gefunden.",
                errorTitle: "Fehler",
                quotaError: "Tageskontingent überschritten.",
                lbl_region: "Region",
                lbl_postal: "PLZ",
                lbl_timezone: "Zeitzone",
                lbl_asn: "ASN",
                lbl_org: "Org",
                lbl_coords: "Koord"
            },
            fr: {
                appTitle: "IPHyper",
                targetList: "Liste des cibles",
                processQueue: "File d'attente",
                waitingData: "En attente de données...",
                editBtn: "Modifier",
                retryBtn: "Réessayer",
                systemStatus: "État du système",
                statusDesc: "Survolez les marqueurs pour voir les détails.",
                defineTarget: "Définir les cibles",
                enterIps: "Entrez les adresses IPv4 à analyser.",
                startAnalysis: "Lancer l'analyse",
                loadDemo: "Charger démo",
                cancelBtn: "Annuler",
                addBtn: "Ajouter",
                notFound: "Non trouvé",
                waiting: "En attente...",
                emptyList: "La liste est vide",
                invalidIP: "Aucune adresse IP valide trouvée.",
                errorTitle: "Erreur",
                quotaError: "Quota quotidien dépassé.",
                lbl_region: "Région",
                lbl_postal: "Postal",
                lbl_timezone: "Fuseau horaire",
                lbl_asn: "ASN",
                lbl_org: "Org",
                lbl_coords: "Coords"
            },
            id: {
                appTitle: "IPHyper",
                targetList: "Daftar Target",
                processQueue: "Antrian Proses",
                waitingData: "Menunggu data...",
                editBtn: "Edit",
                retryBtn: "Coba Lagi",
                systemStatus: "Status Sistem",
                statusDesc: "Arahkan kursor ke penanda untuk melihat detail.",
                defineTarget: "Tentukan Target",
                enterIps: "Masukkan alamat IPv4 untuk dianalisis.",
                startAnalysis: "Mulai Analisis",
                loadDemo: "Muat data demo",
                cancelBtn: "Batal",
                addBtn: "Tambah",
                notFound: "Tidak Ditemukan",
                waiting: "Menunggu...",
                emptyList: "Daftar kosong",
                invalidIP: "Tidak ada alamat IP yang valid ditemukan.",
                errorTitle: "Kesalahan",
                quotaError: "Kuota harian terlampaui.",
                lbl_region: "Wilayah",
                lbl_postal: "Pos",
                lbl_timezone: "Zona Waktu",
                lbl_asn: "ASN",
                lbl_org: "Org",
                lbl_coords: "Koord"
            }
        };

        function detectLanguage() {
            const browserLang = navigator.language.split('-')[0];
            if (translations[browserLang]) {
                return browserLang;
            }
            return 'en';
        }

        function changeLanguage(lang) {
            currentLang = lang;
            document.getElementById('lang-selector').value = lang;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t(key)) {
                    el.innerText = t(key);
                }
            });

            if (currentIpList.length === 0) {
                const container = document.getElementById('ip-list-container');
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-slate-500"><i class="fa-solid fa-layer-group text-3xl mb-3 opacity-20"></i><p class="text-xs">${t('waitingData')}</p></div>`;
            }
        }

        function t(key) {
            if (translations[currentLang] && translations[currentLang][key]) {
                return translations[currentLang][key];
            }
            if (translations['en'][key]) {
                return translations['en'][key];
            }
            return key;
        }

        const demoIpList = [
            "34.121.103.111", "35.238.222.131", "34.26.92.69", "35.227.4.55",
            "34.173.253.20", "34.136.66.240", "35.237.17.157", "34.76.33.29",
            "34.26.113.31", "34.78.94.193", "34.133.129.117", "35.187.115.48",
            "34.139.218.52", "34.30.101.184", "34.72.59.204"
        ];

        let currentIpList = [];
        let map;
        let markers = {};
        let bounds; // Initialized in initMap
        let locationGroups = {};

        // --- CACHE FUNCTIONS ---

        function getCachedData(ip) {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
                const item = cache.find(i => i.ip === ip);
                return item ? item.data : null;
            } catch (e) {
                console.warn("Cache read error:", e);
                return null;
            }
        }

        function addToCache(ip, data) {
            try {
                let cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
                // Remove existing entry for this IP (move to top)
                cache = cache.filter(i => i.ip !== ip);
                // Add new entry to start
                cache.unshift({ ip: ip, data: data });
                // Trim cache
                if (cache.length > MAX_CACHE_SIZE) {
                    cache = cache.slice(0, MAX_CACHE_SIZE);
                }
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            } catch (e) {
                console.warn("Cache write error (likely quota):", e);
            }
        }

        // --- UI FUNCTIONS ---

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            sidebar.classList.toggle('mobile-sidebar-hidden');
            sidebar.classList.toggle('mobile-sidebar-visible');

            if (sidebar.classList.contains('mobile-sidebar-visible')) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function openInputModal() {
            document.getElementById('input-modal').classList.remove('hidden');
            document.getElementById('input-modal').classList.add('flex');
            const textarea = document.getElementById('ip-input-textarea');
            textarea.value = "";
            textarea.focus();

            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('mobile-sidebar-visible')) {
                toggleSidebar();
            }
        }

        function closeInputModal() {
            document.getElementById('input-modal').classList.add('hidden');
            document.getElementById('input-modal').classList.remove('flex');
        }

        function showErrorModal(message) {
            document.getElementById('error-message').innerText = message;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }

        function closeErrorModal() {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
        }

        function fillDemoData() {
            document.getElementById('ip-input-textarea').value = demoIpList.join('\n');
        }

        function processInputAndStart() {
            const rawText = document.getElementById('ip-input-textarea').value;
            const ips = rawText.split(/[\s,]+/).map(ip => ip.trim()).filter(ip => ip.length > 0);

            if (ips.length === 0) return;

            const validIps = ips.filter(ip => /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(ip));

            if (validIps.length === 0) {
                alert(t('invalidIP'));
                return;
            }

            currentIpList = validIps;
            closeInputModal();
            startProcessing();
        }

        // --- MAP FUNCTIONS ---

        function initMap() {
            mapboxgl.accessToken = 'pk.eyJ1IjoicXVhZmxvdyIsImEiOiJjbWkxa25zd20xNHpoMmtzZm9zdHl5c3MxIn0.yZfaJGoMwh-l-TVFxEXR7A';

            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [0, 20],
                zoom: 2,
                minZoom: 2,
                maxZoom: 7,
                projection: 'globe',
                antialias: true,
                config: {
                    basemap: {
                        theme: 'monochrome',
                        light: {
                            sky: {
                                color: '#000000'
                            }
                        }
                    }
                },
            });

            // Listen for style load errors
            map.on('error', (e) => {
                console.error('Map style load error:', e);
            });

            // Modern dark theme with stars and better colors
            map.on('load', () => {
                console.log('Map style loaded successfully');

                // Vercel Style: Minimalist Deep Dark with Stars
                map.setFog({
                    'color': 'rgba(92, 152, 255, 0.2)',
                    'high-color': 'rgba(1, 17, 82, 0.3)',
                    'horizon-blend': 0.03,
                    'space-color': '#0c0c10', // Deep space blue-black to make stars pop
                    'star-intensity': 0.8 // Stars are back! ✨
                });

                // Customize water color - almost black
                try {
                    map.setPaintProperty('water', 'fill-color', '#050505');
                } catch (e) {
                    console.log('Could not set water color');
                }

                // Add subtle glow to globe
                map.setSky({
                    'sky-color': '#000000',
                    'sky-horizon-blend': 0.1,
                    'horizon-color': '#ffffff',
                    'horizon-fog-blend': 5,
                    'fog-color': '#ffffff',
                    'fog-ground-blend': 1,
                    'atmosphere-blend': ['interpolate', ['linear'], ['zoom'], 0, 1, 10, 0.2]
                });
            });

            // Enable smooth transitions
            map.on('style.load', () => {
                map.setFog({});  // Ensure fog is applied
            });

            // map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');
            
            // Initialize bounds
            bounds = new mapboxgl.LngLatBounds();
        }

        function initList() {
            const container = document.getElementById('ip-list-container');
            container.innerHTML = '';

            if (currentIpList.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-[#444]"><i class="fa-solid fa-list-ul text-2xl mb-3 opacity-20"></i><p class="text-xs">${t('emptyList')}</p></div>`;
                return;
            }

            currentIpList.forEach((ip) => {
                const item = document.createElement('div');
                item.id = `ip-item-${ip.replace(/\./g, '-')}`;
                item.className = "bg-[#0a0a0a] border border-[#222] p-3 rounded-md flex items-center justify-between hover:bg-[#111] hover:border-[#444] cursor-pointer transition-all duration-200 group";
                item.onclick = () => zoomToIP(ip);

                item.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-mono text-xs font-semibold text-[#ccc] group-hover:text-white transition-colors">${ip}</span>
                        <span class="text-[10px] text-[#666] location-text mt-0.5">${t('waiting')}</span>
                    </div>
                    <div class="status-icon text-[#444] text-xs">
                        <i class="fa-regular fa-circle"></i>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateUI(ip, data, success) {
            const safeId = ip.replace(/\./g, '-');
            const item = document.getElementById(`ip-item-${safeId}`);
            if (!item) return;

            const locText = item.querySelector('.location-text');
            const iconContainer = item.querySelector('.status-icon');

            if (success) {
                const locationStr = `${data.city}, ${data.country_code}`;
                locText.innerText = locationStr;
                locText.className = "text-[10px] text-white location-text font-medium";
                item.classList.add('border-white/20', 'bg-[#111]');
                iconContainer.innerHTML = `<i class="fa-solid fa-check text-white"></i>`;

                const locKey = `${data.latitude},${data.longitude}`;
                if (!locationGroups[locKey]) {
                    locationGroups[locKey] = [];
                }
                // Store Full Data
                locationGroups[locKey].push({ ip: ip, data: data });

                updateMarkers(locKey, data.latitude, data.longitude);

            } else {
                locText.innerText = t('notFound');
                locText.className = "text-[10px] text-red-500 location-text";
                iconContainer.innerHTML = `<i class="fa-solid fa-xmark text-red-500"></i>`;
            }
        }

        function setLoader(ip, isLoading) {
            const safeId = ip.replace(/\./g, '-');
            const item = document.getElementById(`ip-item-${safeId}`);
            if (!item) return;
            const iconContainer = item.querySelector('.status-icon');
            if (isLoading) iconContainer.innerHTML = `<div class="loader w-3 h-3 border-[#444] border-t-white"></div>`;
        }

        // Updated Marker Logic: Rich Detail Popup with Hover Bridge + SCROLL
        function updateMarkers(locKey, lat, lng) {
            // Remove existing marker for this location if it exists
            if (markers[locKey]) {
                markers[locKey].remove();
            }

            const group = locationGroups[locKey];
            if (!group || group.length === 0) return;

            // Generate Rich Content - Country info once, then IPs
            let content = `<div class="p-3 min-w-[300px] text-left max-h-[300px] overflow-y-auto custom-scroll bg-black text-white">`;

            // First item - show location header
            if (group.length > 0) {
                const firstData = group[0].data;

                // Location Header (shown once)
                content += `
                    <div class="border-b border-[#333] pb-3 mb-3">
                        <!-- Header with Flag and Country -->
                        <div class="flex items-center gap-2 mb-2">
                            ${firstData.flag ? `<img src="${firstData.flag.img}" class="w-6 h-4 object-cover rounded-sm shadow-sm border border-[#333]" alt="${firstData.country_code}">` : ''}
                            <span class="font-bold text-white text-sm">${firstData.city}, ${firstData.country}</span>
                            <span class="text-[10px] text-[#888] font-mono ml-auto">${firstData.continent_code}</span>
                        </div>
                        
                        <!-- Grid Details (Location Info) -->
                        <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-[10px]">
                            <div class="text-[#666]"><span class="text-[#444]">${t('lbl_region')}:</span> ${firstData.region}</div>
                            <div class="text-[#666]"><span class="text-[#444]">${t('lbl_postal')}:</span> ${firstData.postal}</div>
                            <div class="text-[#666]"><span class="text-[#444]">${t('lbl_timezone')}:</span> ${firstData.timezone.id}</div>
                            <div class="text-[#666]"><span class="text-[#444]">UTC:</span> ${firstData.timezone.utc}</div>
                            <div class="col-span-2 text-[#444] border-t border-[#222] pt-1 mt-1 font-mono text-[9px] text-center">
                                ${firstData.latitude}, ${firstData.longitude}
                            </div>
                        </div>
                    </div>
                `;

                // Now list all IPs
                group.forEach((item, index) => {
                    const d = item.data;
                    const isLast = index === group.length - 1;

                    content += `
                        <div class="${isLast ? '' : 'border-b border-[#222] pb-3 mb-3'}">
                            <!-- IP & Org -->
                            <div class="bg-[#111] p-2 rounded-md border border-[#222] hover:border-[#444] transition-colors">
                                 <div class="flex items-center justify-between mb-1">
                                    <span class="font-mono text-xs text-white font-bold">${item.ip}</span>
                                    <span class="text-[10px] text-[#666]">ASN: ${d.connection.asn || '-'}</span>
                                 </div>
                                 <div class="text-[10px] text-[#aaa] truncate" title="${d.connection.org}">
                                    <i class="fa-solid fa-building text-[#444] mr-1"></i> ${d.connection.org || d.connection.isp}
                                 </div>
                                 <div class="text-[10px] text-[#888] truncate mt-0.5">
                                    <i class="fa-solid fa-globe text-[#444] mr-1"></i> ${d.connection.domain || '-'}
                                 </div>
                            </div>
                        </div>
                    `;
                });
            }

            content += `</div>`;

            // Create Marker Element
            const el = document.createElement('div');
            el.className = 'custom-marker-container'; // New container class
            
            const pulse = document.createElement('div');
            pulse.className = 'marker-pulse';
            el.appendChild(pulse);

            // Ensure pointer events work
            el.style.cursor = 'pointer';
            
            // Fix for Mapbox Globe Projection Drift:
            // Mapbox markers on globe view can drift if not handled correctly.
            // Using a simple div with no dimensions as the anchor helps.

            // Create Popup
            const popup = new mapboxgl.Popup({
                offset: 25, 
                closeButton: false,
                closeOnClick: false,
                maxWidth: '350px'
            }).setHTML(content);

            // Create Marker
            const marker = new mapboxgl.Marker({
                element: el,
                anchor: 'center' // Explicitly anchor to center
            })
                .setLngLat([lng, lat])
                .setPopup(popup)
                .addTo(map);

            // Hover Logic
            let timer;
            let isHoveringPopup = false;
            let isHoveringMarker = false;

            // Marker Events (DOM element events)
            // Attach to the visible pulse element for better hover interaction
            el.addEventListener('mouseenter', () => {
                isHoveringMarker = true;
                if (timer) clearTimeout(timer);
                marker.togglePopup(); 
            });

            el.addEventListener('mouseleave', () => {
                isHoveringMarker = false;
                timer = setTimeout(() => {
                    if (!isHoveringPopup && !isHoveringMarker) {
                        marker.getPopup().remove(); 
                    }
                }, 300);
            });

            // Popup Events (we need to wait for it to be added to DOM or attach globally?)
            // Mapbox popup adds to DOM when opened.
            marker.on('dragstart', () => { }); // Dummy

            // Since Mapbox creates/destroys popup DOM on open/close, we need to attach events when it opens.
            // Mapbox doesn't have a direct 'popupopen' event on the marker, but we can check state or 
            // use the map event, but checking specific popup is harder.
            // EASIER WAY: Use the popup's internal behavior or simply attach to the content string? 
            // No, raw HTML string doesn't have events.

            // Solution: Observe popup opening.
            const originalToggle = marker.togglePopup.bind(marker);
            // Override or just let the map 'open' event handle it?

            // Simpler approach for Mapbox:
            // The popup content is added to .mapboxgl-popup-content. 
            // We can try to find it after it opens.

            // Or better: Create the popup DOM element ourselves? 
            // mapboxgl.Popup().setDOMContent() is safer for events.

            const popupContentDiv = document.createElement('div');
            popupContentDiv.innerHTML = content;

            popupContentDiv.addEventListener('mouseenter', () => {
                isHoveringPopup = true;
                if (timer) clearTimeout(timer);
            });

            popupContentDiv.addEventListener('mouseleave', () => {
                isHoveringPopup = false;
                timer = setTimeout(() => {
                    if (!isHoveringPopup && !isHoveringMarker) {
                        marker.getPopup().remove();
                    }
                }, 300);
            });

            popup.setDOMContent(popupContentDiv);

            markers[locKey] = marker;
            group.forEach(item => {
                markers[item.ip] = locKey;
            });

            bounds.extend([lng, lat]);
            map.fitBounds(bounds, { padding: 100, maxZoom: 10 });
        }

        function zoomToIP(ip) {
            const locKey = markers[ip];
            if (locKey && markers[locKey]) {
                const marker = markers[locKey];
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('mobile-sidebar-visible')) {
                    toggleSidebar();
                }

                const lngLat = marker.getLngLat();

                map.flyTo({
                    center: lngLat,
                    zoom: 8,
                    speed: 1.5,
                    curve: 1
                });

                // Open popup after flying
                setTimeout(() => {
                    if (!marker.getPopup().isOpen()) {
                        marker.togglePopup();
                    }
                }, 1500);
            }
        }

        async function fetchIPData(ip) {
            try {
                // Check Cache First
                const cached = getCachedData(ip);
                if (cached) {
                    // Use cached data
                    updateUI(ip, cached, true);
                    return;
                }

                // If not cached, fetch
                setLoader(ip, true);
                await new Promise(r => setTimeout(r, 250));
                const response = await fetch(`https://ipwho.is/${ip}`);
                const data = await response.json();
                setLoader(ip, false);

                if (data.success) {
                    // Save to cache on success
                    addToCache(ip, data);
                    updateUI(ip, data, true);
                } else {
                    // Check if failure is due to Quota
                    if (data.message && (data.message.toLowerCase().includes("rate") || data.message.toLowerCase().includes("quota"))) {
                        showErrorModal(t('quotaError'));
                    }
                    updateUI(ip, null, false);
                }
            } catch (error) {
                console.error("Fetch Hatası:", error);
                setLoader(ip, false);
                updateUI(ip, null, false);
            }
        }

        async function startProcessing() {
            if (markers) {
                Object.values(markers).forEach(val => {
                    if (typeof val === 'object' && val.remove) {
                        val.remove();
                    }
                });
            }
            markers = {};
            locationGroups = {};
            bounds = new mapboxgl.LngLatBounds();

            const btn = document.getElementById('refresh-btn');
            const countDisplay = document.getElementById('status-count');
            const totalDisplay = document.getElementById('total-count');

            btn.disabled = true;

            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<div class="loader w-3 h-3 border-slate-400 border-t-transparent mx-auto"></div>`;

            initList();

            totalDisplay.innerText = currentIpList.length;
            countDisplay.innerText = "0";

            let processedCount = 0;

            for (const ip of currentIpList) {
                await fetchIPData(ip);
                processedCount++;
                countDisplay.innerText = processedCount;
            }

            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }

        window.onload = function () {
            // Detect Language
            const detected = detectLanguage();
            changeLanguage(detected);

            initMap();
            openInputModal();
        };

    </script>
</body>

</html>